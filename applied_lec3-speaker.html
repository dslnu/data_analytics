<!DOCTYPE html>
<html lang="en"><head>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/tabby.min.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.8.25">

  <meta name="author" content="MSDE">
  <title>Big Data analytics / Applied Data analytics – Docker Networking</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="site_libs/revealjs/dist/theme/quarto-534cd8e3a96973385dffff3f4709048d.css">
  <link rel="stylesheet" href="./custom.css">
  <link href="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" data-background-image="img/docker_ship.jpg" data-background-opacity="0.5" data-background-size="contain" class="quarto-title-block center">
  <h1 class="title">Docker Networking</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
MSDE 
</div>
        <p class="quarto-title-affiliation">
            Lviv University
          </p>
    </div>
</div>

</section>
<section>
<section id="container-networking-basics" class="title-slide slide level1 center">
<h1>Container networking basics</h1>

</section>
<section id="container-networking-basics-1" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Objectives</strong></p>
</div>
<div class="callout-content">
<p>We will now run network services (accepting requests) in containers.</p>
<p>At the end of this section, you will be able to:</p>
<ul>
<li><p>Run a network service in a container.</p></li>
<li><p>Connect to that network service.</p></li>
<li><p>Find a container’s IP address.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-2" class="slide level2 font8 scrollable">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Definitions</strong></p>
</div>
<div class="callout-content">
<table class="caption-top">
<colgroup>
<col style="width: 40%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>Keyword</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>VM</td>
<td>A virtual machine (VM) is a software simulation of a physical computer that runs on a host computer. It provides a separate operating system and resources, allowing multiple operating systems to run on a single physical machine.</td>
</tr>
<tr class="even">
<td>Cluster</td>
<td>A cluster is a group of connected servers that work together as a single system to provide high availability, scalability, and increased performance for applications. The nodes in a cluster are connected through a network and share resources to provide a unified, highly available solution.</td>
</tr>
<tr class="odd">
<td>Node</td>
<td>A cluster node is a single server within a cluster computing system. It provides computing resources and works together with other nodes to perform tasks as a unified system, providing high availability and scalability for applications.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-3" class="slide level2 font8">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Definitions</strong></p>
</div>
<div class="callout-content">
<table class="caption-top">
<colgroup>
<col style="width: 40%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>Keyword</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Network</td>
<td>A network is a group of interconnected devices that can exchange data and information. Networks can be used to connect computers, servers, mobile devices, and other types of devices and allow them to communicate with each other and share resources, such as printers and storage. More specifically in our case, these are physical and software-defined communication paths between individual nodes of a cluster and programs running on those nodes.</td>
</tr>
<tr class="even">
<td>Port</td>
<td>A port is a communication endpoint in a network-attached device, such as a computer or server. It allows the device to receive and send data to other devices on the network through a specific network protocol, such as TCP or UDP. Each port has a unique number that is used to identify it, and different services and applications use specific ports to communicate.</td>
</tr>
<tr class="odd">
<td>Service</td>
<td>A piece of software that implements a limited set of functionalities that are then used by other parts of the application.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-4" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Running a very simple service</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>We need something small, simple, easy to configure</p>
<p>(or, even better, that doesn’t require any configuration at all)</p></li>
<li><p>Let’s use the official NGINX image (named <code>nginx</code>)</p></li>
<li><p>It runs a static web server listening on port 80</p></li>
<li><p>It serves a default “Welcome to nginx!” page</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-5" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Running an NGINX server</strong></p>
</div>
<div class="callout-content">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">-P</span> nginx</span>
<span id="cb1-2"><a></a><span class="ex">66b1ce719198711292c8f34f84a7b68c3876cf9f67015e752b94e189d35a204e</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><p>Docker will automatically pull the <code>nginx</code> image from the Docker Hub</p></li>
<li><p><code>-d</code> / <code>--detach</code> tells Docker to run it in the background</p></li>
<li><p><code>P</code> / <code>--publish-all</code> tells Docker to publish all ports</p>
<p>(publish = make them reachable from other computers)</p></li>
<li><p>…OK, how do we connect to our web server now?</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-6" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Finding our web server port</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>First, we need to find the <em>port number</em> used by Docker</p>
<p>(the NGINX container listens on port 80, but this port will be <em>mapped</em>)</p></li>
<li><p>We can use <code>docker ps</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a></a><span class="ex">$</span> docker ps</span>
<span id="cb2-2"><a></a><span class="ex">CONTAINER</span> ID  IMAGE  ...  PORTS                  ...</span>
<span id="cb2-3"><a></a><span class="ex">e40ffb406c9e</span>  nginx  ...  0.0.0.0:<span class="kw">`</span><span class="ex">12345</span><span class="kw">`</span><span class="at">-</span><span class="op">&gt;</span>80/tcp  ...</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p>This means:</p>
<p><em>port 12345 on the Docker host is mapped to port 80 in the container</em></p></li>
<li><p>Now we need to connect to the Docker host!</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-7" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Finding the address of the Docker host</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>When running Docker on your Linux workstation:</p>
<p><em>use <code>localhost</code>, or any IP address of your machine</em></p></li>
<li><p>When running Docker on a remote Linux server:</p>
<p><em>use any IP address of the remote machine</em></p></li>
<li><p>When running Docker Desktop on Mac or Windows:</p>
<p><em>use <code>localhost</code></em></p></li>
<li><p>In other scenarios (<code>docker-machine</code>, local VM…):</p>
<p><em>use the IP address of the Docker VM</em></p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-8" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Connecting to our web server (GUI)</strong></p>
</div>
<div class="callout-content">
<p>Point your browser to the IP address of your Docker host, on the port shown by <code>docker ps</code> for container port 80.</p>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="img/welcome-to-nginx.png"></p>
<figcaption>Screenshot</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-9" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Connecting to our web server (CLI)</strong></p>
</div>
<div class="callout-content">
<p>You can also use <code>curl</code> directly from the Docker host.</p>
<p>Make sure to use the right port number if it is different from the example below:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a></a><span class="ex">$</span> curl localhost:12345</span>
<span id="cb3-2"><a></a><span class="op">&lt;</span>!DOCTYPE <span class="ex">html</span><span class="op">&gt;</span></span>
<span id="cb3-3"><a></a><span class="op">&lt;</span>html<span class="op">&gt;</span></span>
<span id="cb3-4"><a></a><span class="op">&lt;</span>head<span class="op">&gt;</span></span>
<span id="cb3-5"><a></a><span class="op">&lt;</span>title<span class="op">&gt;</span>Welcome <span class="ex">to</span> nginx!<span class="op">&lt;</span>/title<span class="op">&gt;</span></span>
<span id="cb3-6"><a></a><span class="ex">...</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-10" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>How does Docker know which port to map?</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>There is metadata in the image telling “this image has something on port 80”.</p></li>
<li><p>We can see that metadata with <code>docker inspect</code>:</p></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a></a><span class="ex">$</span> docker inspect <span class="at">--format</span> <span class="st">'{{.Config.ExposedPorts}}'</span> nginx</span>
<span id="cb4-2"><a></a><span class="va">map</span><span class="op">[</span><span class="dv">80</span>/tcp:{}<span class="op">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><p>This metadata was set in the Dockerfile, with the <code>EXPOSE</code> keyword.</p></li>
<li><p>We can see that with <code>docker history</code>:</p></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a></a><span class="ex">$</span> docker history nginx</span>
<span id="cb5-2"><a></a><span class="ex">IMAGE</span>               CREATED             CREATED BY</span>
<span id="cb5-3"><a></a><span class="ex">7f70b30f2cc6</span>        11 days ago         /bin/sh <span class="at">-c</span> <span class="co">#(nop)  CMD ["nginx" "-g" "…</span></span>
<span id="cb5-4"><a></a><span class="op">&lt;</span>missing<span class="op">&gt;</span>           11 <span class="ex">days</span> ago         /bin/sh <span class="at">-c</span> <span class="co">#(nop)  STOPSIGNAL [SIGTERM]</span></span>
<span id="cb5-5"><a></a><span class="op">&lt;</span>missing<span class="op">&gt;</span>           11 <span class="ex">days</span> ago         /bin/sh <span class="at">-c</span> <span class="co">#(nop)  EXPOSE 80/tcp</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-11" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Why can’t we just connect to port 80?</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Our Docker host has only one port 80</p></li>
<li><p>Therefore, we can only have one container at a time on port 80</p></li>
<li><p>Therefore, if multiple containers want port 80, only one can get it</p></li>
<li><p>By default, containers <em>do not</em> get “their” port number, but a random one</p>
<p>(not “random” as “crypto random”, but as “it depends on various factors”)</p></li>
<li><p>We’ll see later how to force a port number (including port 80!)</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-12" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Using multiple IP addresses</strong></p>
</div>
<div class="callout-content">
<p><em>Hey, my network-fu is strong, and I have questions…</em></p>
<ul>
<li><p>Can I publish one container on 127.0.0.2:80, and another on 127.0.0.3:80?</p></li>
<li><p>My machine has multiple (public) IP addresses, let’s say A.A.A.A and B.B.B.B. <br> Can I have one container on A.A.A.A:80 and another on B.B.B.B:80?</p></li>
<li><p>I have a whole IPV4 subnet, can I allocate it to my containers?</p></li>
<li><p>What about IPV6?</p></li>
</ul>
<p>You can do all these things when running Docker directly on Linux.</p>
<p>(On other platforms, <em>generally not</em>, but there are some exceptions.)</p>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-13" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Finding the web server port in a script</strong></p>
</div>
<div class="callout-content">
<p>Parsing the output of <code>docker ps</code> would be painful.</p>
<p>There is a command to help us:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a></a><span class="ex">$</span> docker port <span class="op">&lt;</span>containerID<span class="op">&gt;</span> 80</span>
<span id="cb6-2"><a></a><span class="ex">0.0.0.0:12345</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-14" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Manual allocation of port numbers</strong></p>
</div>
<div class="callout-content">
<p>If you want to set port numbers yourself, no problem:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">-p</span> 80:80 nginx</span>
<span id="cb7-2"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">-p</span> 8000:80 nginx</span>
<span id="cb7-3"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">-p</span> 8080:80 <span class="at">-p</span> 8888:80 nginx</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>We are running three NGINX web servers.</li>
<li>The first one is exposed on port 80.</li>
<li>The second one is exposed on port 8000.</li>
<li>The third one is exposed on ports 8080 and 8888.</li>
</ul>
</div>
</div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>The convention is <code>port-on-host:port-on-container</code>.</p>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-15" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Plumbing containers into your infrastructure</strong></p>
</div>
<div class="callout-content">
<p>There are many ways to integrate containers in your network.</p>
<ul>
<li><p>Start the container, letting <span style="color:blue;">Docker allocate</span> a public port for it. <br>Then retrieve that port number and feed it to your configuration.</p></li>
<li><p>Pick a <span style="color:blue;">fixed port</span> number in advance, when you generate your configuration. <br>Then start your container by setting the port numbers manually.</p></li>
<li><p>Use an <span style="color:blue;">orchestrator</span> like Kubernetes or Swarm. <br>The orchestrator will provide its own networking facilities.</p></li>
</ul>
<p>Orchestrators typically provide mechanisms to enable direct container-to-container communication across hosts, and publishing/load balancing for inbound traffic.</p>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-16" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Finding the container’s IP address</strong></p>
</div>
<div class="callout-content">
<p>We can use the <code>docker inspect</code> command to find the IP address of the container.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a></a><span class="ex">$</span> docker inspect <span class="at">--format</span> <span class="st">'{{ .NetworkSettings.IPAddress }}'</span> <span class="op">&lt;</span>yourContainerID<span class="op">&gt;</span></span>
<span id="cb8-2"><a></a><span class="ex">172.17.0.3</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><p><code>docker inspect</code> is an advanced command, that can retrieve a ton of information about our containers.</p></li>
<li><p>Here, we provide it with a format string to extract exactly the private IP address of the container.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-17" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Pinging our container</strong></p>
</div>
<div class="callout-content">
<p>Let’s try to ping our container <em>from another container.</em></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a></a><span class="ex">docker</span> run alpine ping <span class="kw">`</span><span class="op">&lt;</span>ipaddress<span class="op">&gt;</span><span class="kw">`</span></span>
<span id="cb9-2"><a></a><span class="ex">PING</span> 172.17.0.X <span class="er">(</span><span class="ex">172.17.0.X</span><span class="kw">)</span><span class="bu">:</span> 56 data bytes</span>
<span id="cb9-3"><a></a><span class="ex">64</span> bytes from 172.17.0.X: seq=0 ttl=64 time=0.106 ms</span>
<span id="cb9-4"><a></a><span class="ex">64</span> bytes from 172.17.0.X: seq=1 ttl=64 time=0.250 ms</span>
<span id="cb9-5"><a></a><span class="ex">64</span> bytes from 172.17.0.X: seq=2 ttl=64 time=0.188 ms</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>When running on Linux, we can even ping that IP address directly!</p>
<p>(And connect to a container’s ports even if they aren’t published.)</p>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-18" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>How often do we use <code>-p</code> and <code>-P</code> ?</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>When running a stack of containers, we will often use Compose</p></li>
<li><p>Compose will take care of exposing containers</p>
<p>(through a <code>ports:</code> section in the <code>docker-compose.yml</code> file)</p></li>
<li><p>It is, however, fairly common to use <code>docker run -P</code> for a quick test</p></li>
<li><p>Or <code>docker run -p ...</code> when an image doesn’t <code>EXPOSE</code> a port correctly</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-networking-basics-19" class="slide level2">
<h2>Container networking basics</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Section summary</strong></p>
</div>
<div class="callout-content">
<p>We’ve learned how to:</p>
<ul>
<li><p>Expose a network port.</p></li>
<li><p>Connect to an application running in a container.</p></li>
<li><p>Find a container’s IP address.</p></li>
</ul>
</div>
</div>
</div>
</section></section>
<section>
<section id="container-network-drivers" class="title-slide slide level1 center">
<h1>Container network drivers</h1>

</section>
<section id="container-network-drivers-1" class="slide level2">
<h2>Container network drivers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Overview</strong></p>
</div>
<div class="callout-content">
<p>The Docker Engine supports different network drivers.</p>
<p>The built-in drivers include:</p>
<ul>
<li><p><code>bridge</code> (default)</p></li>
<li><p><code>null</code> (for the special network called <code>none</code>)</p></li>
<li><p><code>host</code> (for the special network called <code>host</code>)</p></li>
<li><p><code>container</code> (that one is a bit magic!)</p></li>
</ul>
<p>The network is selected with <code>docker run --net ...</code>.</p>
<p>Each network is managed by a <span style="color:blue;"><strong>driver</strong></span>.</p>
<p>The different drivers are explained with more details on the following slides.</p>
</div>
</div>
</div>
</section>
<section id="container-network-drivers-2" class="slide level2">
<h2>Container network drivers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>The default bridge</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>By default, the container gets a virtual <code>eth0</code> interface. <br>(In addition to its own private <code>lo</code> loopback interface.)</p></li>
<li><p>That interface is provided by a <code>veth</code> pair.</p></li>
<li><p>It is connected to the Docker bridge. <br>(Named <code>docker0</code> by default; configurable with <code>--bridge</code>.)</p></li>
<li><p>Addresses are allocated on a private, internal subnet. <br>(Docker uses 172.17.0.0/16 by default; configurable with <code>--bip</code>.)</p></li>
<li><p>Outbound traffic goes through an iptables MASQUERADE rule.</p></li>
<li><p>Inbound traffic goes through an iptables DNAT rule.</p></li>
<li><p>The container can have its own routes, iptables rules, etc.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-network-drivers-3" class="slide level2">
<h2>Container network drivers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>The null driver</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Container is started with <code>docker run --net none ...</code></p></li>
<li><p>It only gets the <code>lo</code> loopback interface. No <code>eth0</code>.</p></li>
<li><p>It can’t send or receive network traffic.</p></li>
<li><p>Useful for isolated/untrusted workloads.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-network-drivers-4" class="slide level2">
<h2>Container network drivers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>The host driver</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Container is started with <code>docker run --net host ...</code></p></li>
<li><p>It sees (and can access) the network interfaces of the host.</p></li>
<li><p>It can bind any address, any port (for ill and for good).</p></li>
<li><p>Network traffic doesn’t have to go through NAT, bridge, or veth.</p></li>
<li><p>Performance = native!</p></li>
</ul>
<p>Use cases:</p>
<ul>
<li><p>Performance sensitive applications (VOIP, gaming, streaming…)</p></li>
<li><p>Peer discovery (e.g.&nbsp;Erlang port mapper, Raft, Serf…)</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="container-network-drivers-5" class="slide level2">
<h2>Container network drivers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>The container driver</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Container is started with <code>docker run --net container:id ...</code></p></li>
<li><p>It re-uses the network stack of another container.</p></li>
<li><p>It shares with this other container the same interfaces, IP address(es), routes, iptables rules, etc.</p></li>
<li><p>Those containers can communicate over their <code>lo</code> interface. <br>(i.e.&nbsp;one can bind to 127.0.0.1 and the others can connect to it.)</p></li>
</ul>
</div>
</div>
</div>
</section></section>
<section>
<section id="the-container-network-model" class="title-slide slide level1 center">
<h1>The Container Network Model</h1>

</section>
<section id="the-container-network-model-1" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Objectives</strong></p>
</div>
<div class="callout-content">
<p>We will learn about the CNM (Container Network Model).</p>
<p>At the end of this lesson, you will be able to:</p>
<ul>
<li><p>Create a private network for a group of containers.</p></li>
<li><p>Use container naming to connect services together.</p></li>
<li><p>Dynamically connect and disconnect containers to networks.</p></li>
<li><p>Set the IP address of a container.</p></li>
</ul>
<p>We will also explain the principle of overlay networks and network plugins.</p>
</div>
</div>
</div>
</section>
<section id="the-container-network-model-2" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>The Container Network Model</strong></p>
</div>
<div class="callout-content">
<p>Docker has “networks”.</p>
<p>We can manage them with the <code>docker network</code> commands; for instance:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a></a><span class="ex">$</span> docker network ls</span>
<span id="cb10-2"><a></a><span class="ex">NETWORK</span> ID          NAME                DRIVER</span>
<span id="cb10-3"><a></a><span class="ex">6bde79dfcf70</span>        bridge              bridge</span>
<span id="cb10-4"><a></a><span class="ex">8d9c78725538</span>        none                null</span>
<span id="cb10-5"><a></a><span class="ex">eb0eeab782f4</span>        host                host</span>
<span id="cb10-6"><a></a><span class="ex">4c1ff84d6d3f</span>        blog-dev            overlay</span>
<span id="cb10-7"><a></a><span class="ex">228a4355d548</span>        blog-prod           overlay</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>New networks can be created (with <code>docker network create</code>).</p>
<p>(Note: networks <code>none</code> and <code>host</code> are special; let’s set them aside for now.)</p>
</div>
</div>
</div>
</section>
<section id="the-container-network-model-4" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>What’s a network?</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Conceptually, a Docker “network” is a virtual switch</p>
<p>(we can also think about it like a VLAN, or a WiFi SSID, for instance)</p></li>
<li><p>By default, containers are connected to a single network</p>
<p>(but they can be connected to zero, or many networks, even dynamically)</p></li>
<li><p>Each network has its own subnet (IP address range)</p></li>
<li><p>A network can be local (to a single Docker Engine) or global (span multiple hosts)</p></li>
<li><p>Containers can have <em>network aliases</em> providing DNS-based service discovery</p>
<p>(and each network has its own “domain”, “zone”, or “scope”)</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="the-container-network-model-5" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Service discovery</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>A container can be given a network alias</p>
<p>(e.g.&nbsp;with <code>docker run --net some-network --net-alias db ...</code>)</p></li>
<li><p>The containers running in the same network can resolve that network alias</p>
<p>(i.e.&nbsp;if they do a DNS lookup on <code>db</code>, it will give the container’s address)</p></li>
<li><p>We can have a different <code>db</code> container in each network</p>
<p>(this avoids naming conflicts between different stacks)</p></li>
<li><p>When we name a container, it automatically adds the name as a network alias</p>
<p>(i.e.&nbsp;<code>docker run --name xyz ...</code> is like <code>docker run --net-alias xyz ...</code></p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="the-container-network-model-6" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-warning no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Network isolation</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Networks are isolated</p></li>
<li><p>By default, containers in network A cannot reach those in network B</p></li>
<li><p>A container connected to both networks A and B can act as a router or proxy</p></li>
<li><p>Published ports are always reachable through the Docker host address</p>
<p>(<code>docker run -P ...</code> makes a container port available to everyone)</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="the-container-network-model-7" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>How to use networks</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>We typically create one network per “stack” or app that we deploy</p></li>
<li><p>More complex apps or stacks might require multiple networks</p>
<p>(e.g.&nbsp;<code>frontend</code>, <code>backend</code>, …)</p></li>
<li><p>Networks allow us to deploy multiple copies of the same stack</p>
<p>(e.g.&nbsp;<code>prod</code>, <code>dev</code>, <code>pr-442</code>, ….)</p></li>
<li><p>If we use Docker Compose, this is managed automatically for us</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="the-container-network-model-8" class="slide level2">
<h2>The Container Network Model</h2>

<img data-src="img/docker-networking-default-bridge-linux.png" class="r-stretch quarto-figure-center"><p class="caption">Multiple containers on the default bridge network, on a Linux machine</p></section>
<section id="the-container-network-model-9" class="slide level2">
<h2>The Container Network Model</h2>

<img data-src="img/docker-networking-networks-linux.png" class="r-stretch quarto-figure-center"><p class="caption">Multiple containers in multiple bridge networks, on a Linux machine</p></section>
<section id="the-container-network-model-10" class="slide level2">
<h2>The Container Network Model</h2>

<img data-src="img/docker-networking-networks-macwin.png" class="r-stretch quarto-figure-center"><p class="caption">Multiple containers in multiple bridge networks, on a Mac/Windows machine</p></section>
<section id="the-container-network-model-11" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>CNM vs CNI</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>CNM is the model used by Docker</p></li>
<li><p>Kubernetes uses a different model, architectured around CNI</p>
<p>(CNI is a kind of API between a container engine and <em>CNI plugins</em>)</p></li>
<li><p>Docker model:</p>
<ul>
<li>multiple isolated networks</li>
<li>per-network service discovery</li>
<li>network interconnection requires extra steps</li>
</ul></li>
<li><p>Kubernetes model:</p>
<ul>
<li>single flat network</li>
<li>per-namespace service discovery</li>
<li>network isolation requires extra steps (Network Policies)</li>
</ul></li>
</ul>
</div>
</div>
</div>
</section>
<section id="the-container-network-model-12" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Creating a network</strong></p>
</div>
<div class="callout-content">
<p>Let’s create a network called <code>dev</code>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a></a><span class="ex">$</span> docker network create dev</span>
<span id="cb11-2"><a></a><span class="ex">4c1ff84d6d3f1733d3e233ee039cac276f425a9d5228a4355d54878293a889ba</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The network is now visible with the <code>network ls</code> command:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a></a><span class="ex">$</span> docker network ls</span>
<span id="cb12-2"><a></a><span class="ex">NETWORK</span> ID          NAME                DRIVER</span>
<span id="cb12-3"><a></a><span class="ex">6bde79dfcf70</span>        bridge              bridge</span>
<span id="cb12-4"><a></a><span class="ex">8d9c78725538</span>        none                null</span>
<span id="cb12-5"><a></a><span class="ex">eb0eeab782f4</span>        host                host</span>
<span id="cb12-6"><a></a><span class="ex">4c1ff84d6d3f</span>        dev                 bridge</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="the-container-network-model-13" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Placing containers on a network</strong></p>
</div>
<div class="callout-content">
<p>We will create a <em>named</em> container on this network.</p>
<p>It will be reachable with its name, <code>es</code>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">--name</span> es <span class="at">--net</span> dev elasticsearch:2</span>
<span id="cb13-2"><a></a><span class="ex">8abb80e229ce8926c7223beb69699f5f34d6f1d438bfc5682db893e798046863</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="the-container-network-model-14" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Communication between containers</strong></p>
</div>
<div class="callout-content">
<p>Now, create another container on this network.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a></a><span class="ex">$</span> docker run <span class="at">-ti</span> <span class="at">--net</span> dev alpine sh</span>
<span id="cb14-2"><a></a><span class="ex">root@0ecccdfa45ef:/#</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>From this new container, we can resolve and ping the other one, using its assigned name:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a></a><span class="ex">/</span> <span class="co"># ping es</span></span>
<span id="cb15-2"><a></a><span class="ex">PING</span> es <span class="er">(</span><span class="ex">172.18.0.2</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb15-3"><a></a><span class="ex">64</span> bytes from es.dev <span class="er">(</span><span class="ex">172.18.0.2</span><span class="kw">)</span><span class="bu">:</span> icmp_seq=1 ttl=64 time=0.221 ms</span>
<span id="cb15-4"><a></a><span class="ex">64</span> bytes from es.dev <span class="er">(</span><span class="ex">172.18.0.2</span><span class="kw">)</span><span class="bu">:</span> icmp_seq=2 ttl=64 time=0.114 ms</span>
<span id="cb15-5"><a></a><span class="ex">64</span> bytes from es.dev <span class="er">(</span><span class="ex">172.18.0.2</span><span class="kw">)</span><span class="bu">:</span> icmp_seq=3 ttl=64 time=0.114 ms</span>
<span id="cb15-6"><a></a><span class="ex">^C</span></span>
<span id="cb15-7"><a></a><span class="ex">---</span> es ping statistics <span class="at">---</span></span>
<span id="cb15-8"><a></a><span class="ex">3</span> packets transmitted, 3 received, 0% packet loss, time 2000ms</span>
<span id="cb15-9"><a></a><span class="ex">rtt</span> min/avg/max/mdev = 0.114/0.149/0.221/0.052 ms</span>
<span id="cb15-10"><a></a><span class="ex">root@0ecccdfa45ef:/#</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="the-container-network-model-15" class="slide level2">
<h2>The Container Network Model</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Resolving container addresses</strong></p>
</div>
<div class="callout-content">
<p>Since Docker Engine 1.10, name resolution is implemented by a dynamic resolver.</p>
<p>Archeological note: when CNM was introduced (in Docker Engine 1.9, November 2015) name resolution was implemented with <code>/etc/hosts</code>, and it was updated each time CONTAINERs were added/removed. This could cause interesting race conditions since <code>/etc/hosts</code> was a bind-mount (and couldn’t be updated atomically).</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a></a><span class="ex">[root@0ecccdfa45ef</span> /]# cat /etc/hosts</span>
<span id="cb16-2"><a></a><span class="ex">172.18.0.3</span>  0ecccdfa45ef</span>
<span id="cb16-3"><a></a><span class="ex">127.0.0.1</span>       localhost</span>
<span id="cb16-4"><a></a><span class="ex">::1</span>     localhost ip6-localhost ip6-loopback</span>
<span id="cb16-5"><a></a><span class="ex">fe00::0</span> ip6-localnet</span>
<span id="cb16-6"><a></a><span class="ex">ff00::0</span> ip6-mcastprefix</span>
<span id="cb16-7"><a></a><span class="ex">ff02::1</span> ip6-allnodes</span>
<span id="cb16-8"><a></a><span class="ex">ff02::2</span> ip6-allrouters</span>
<span id="cb16-9"><a></a><span class="ex">172.18.0.2</span>      es</span>
<span id="cb16-10"><a></a><span class="ex">172.18.0.2</span>      es.dev</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section></section>
<section>
<section id="service-discovery-with-containers" class="title-slide slide level1 center">
<h1>Service discovery with containers</h1>

</section>
<section id="service-discovery-with-containers-1" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Overview</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Let’s try to run an application that requires two containers.</p></li>
<li><p>The first container is a web server.</p></li>
<li><p>The other one is a redis data store.</p></li>
<li><p>We will place them both on the <code>dev</code> network created before.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-2" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Running the web server</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>The application is provided by the container image <code>jpetazzo/trainingwheels</code>.</p></li>
<li><p>We don’t know much about it so we will try to run it and see what happens!</p></li>
</ul>
<p>Start the container, exposing all its ports:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a></a><span class="ex">$</span> docker run <span class="at">--net</span> dev <span class="at">-d</span> <span class="at">-P</span> jpetazzo/trainingwheels</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Check the port that has been allocated to it:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a></a><span class="ex">$</span> docker ps <span class="at">-l</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-3" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Test the web server</strong></p>
</div>
<div class="callout-content">
<ul>
<li>If we connect to the application now, we will see an error page:</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="img/trainingwheels-error.png"></p>
<figcaption>Trainingwheels error</figcaption>
</figure>
</div>
<ul>
<li>This is because the Redis service is not running.</li>
<li>This container tries to resolve the name <code>redis</code>.</li>
</ul>
<p>Note: we’re not using a FQDN or an IP address here; just <code>redis</code>.</p>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-4" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Start the data store</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>We need to start a Redis container.</p></li>
<li><p>That container must be on the same network as the web server.</p></li>
<li><p>It must have the right network alias (<code>redis</code>) so the application can find it.</p></li>
</ul>
<p>Start the container:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a></a><span class="ex">$</span> docker run <span class="at">--net</span> dev <span class="at">--net-alias</span> redis <span class="at">-d</span> redis</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-5" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Test the web server again</strong></p>
</div>
<div class="callout-content">
<ul>
<li>If we connect to the application now, we should see that the app is working correctly:</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="img/trainingwheels-ok.png"></p>
<figcaption>Trainingwheels OK</figcaption>
</figure>
</div>
<ul>
<li>When the app tries to resolve <code>redis</code>, instead of getting a DNS error, it gets the IP address of our Redis container.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-6" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>A few words on <em>scope</em></strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Container names are unique (there can be only one <code>--name redis</code>)</p></li>
<li><p>Network aliases are not unique</p></li>
<li><p>We can have the same network alias in different networks:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a></a><span class="ex">docker</span> run <span class="at">--net</span> dev <span class="at">--net-alias</span> redis ...</span>
<span id="cb20-2"><a></a><span class="ex">docker</span> run <span class="at">--net</span> prod <span class="at">--net-alias</span> redis ...</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p>We can even have multiple containers with the same alias in the same network</p>
<p>(in that case, we get multiple DNS entries, aka “DNS round robin”)</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-7" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Names are <em>local</em> to each network</strong></p>
</div>
<div class="callout-content">
<p>Let’s try to ping our <code>es</code> container from another container, when that other container is <em>not</em> on the <code>dev</code> network.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a></a><span class="ex">$</span> docker run <span class="at">--rm</span> alpine ping es</span>
<span id="cb21-2"><a></a><span class="ex">ping:</span> bad address <span class="st">'es'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Names can be resolved only when containers are on the same network.</p>
<p>Containers can contact each other only when they are on the same network (you can try to ping using the IP address to verify).</p>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-8" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Network aliases</strong></p>
</div>
<div class="callout-content">
<ul>
<li>We would like to have another network, <code>prod</code>, with its own <code>es</code> container. But there can be only one container named <code>es</code>!</li>
<li>We will use <em>network aliases</em>.</li>
<li>A container can have multiple network aliases.</li>
<li>Network aliases are <em>local</em> to a given network (only exist in this network).</li>
<li>Multiple containers can have the same network alias (even on the same network).</li>
<li>Since Docker Engine 1.11, resolving a network alias yields the IP addresses of all containers holding this alias.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-9" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Creating containers on another network</strong></p>
</div>
<div class="callout-content">
<p>Create the <code>prod</code> network.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a></a><span class="ex">$</span> docker network create prod</span>
<span id="cb22-2"><a></a><span class="ex">5a41562fecf2d8f115bedc16865f7336232a04268bdf2bd816aecca01b68d50c</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We can now create multiple containers with the <code>es</code> alias on the new <code>prod</code> network.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">--name</span> prod-es-1 <span class="at">--net-alias</span> es <span class="at">--net</span> prod elasticsearch:2</span>
<span id="cb23-2"><a></a><span class="ex">38079d21caf0c5533a391700d9e9e920724e89200083df73211081c8a356d771</span></span>
<span id="cb23-3"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">--name</span> prod-es-2 <span class="at">--net-alias</span> es <span class="at">--net</span> prod elasticsearch:2</span>
<span id="cb23-4"><a></a><span class="ex">1820087a9c600f43159688050dcc164c298183e1d2e62d5694fd46b10ac3bc3d</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-10" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Resolving network aliases</strong></p>
</div>
<div class="callout-content">
<p>Let’s try DNS resolution first, using the <code>nslookup</code> tool that ships with the <code>alpine</code> image.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a></a><span class="ex">$</span> docker run <span class="at">--net</span> prod <span class="at">--rm</span> alpine nslookup es</span>
<span id="cb24-2"><a></a><span class="ex">Name:</span>      es</span>
<span id="cb24-3"><a></a><span class="ex">Address</span> 1: 172.23.0.3 prod-es-2.prod</span>
<span id="cb24-4"><a></a><span class="ex">Address</span> 2: 172.23.0.2 prod-es-1.prod</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>(You can ignore the <code>can't resolve '(null)'</code> errors.)</p>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-11" class="slide level2 font8">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Connecting to aliased containers</strong></p>
</div>
<div class="callout-content">
<p>Each ElasticSearch instance has a name (generated when it is started). This name can be seen when we issue a simple HTTP request on the ElasticSearch API endpoint.</p>
<p>Try the following command a few times:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a></a><span class="ex">$</span> docker run <span class="at">--rm</span> <span class="at">--net</span> dev centos curl <span class="at">-s</span> es:9200</span>
<span id="cb25-2"><a></a><span class="kw">{</span></span>
<span id="cb25-3"><a></a>  <span class="st">"name"</span> : <span class="st">"Tarot"</span>,</span>
<span id="cb25-4"><a></a><span class="ex">...</span></span>
<span id="cb25-5"><a></a><span class="kw">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then try it a few times by replacing <code>--net dev</code> with <code>--net prod</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a></a><span class="ex">$</span> docker run <span class="at">--rm</span> <span class="at">--net</span> prod centos curl <span class="at">-s</span> es:9200</span>
<span id="cb26-2"><a></a><span class="kw">{</span></span>
<span id="cb26-3"><a></a>  <span class="st">"name"</span> : <span class="st">"The Symbiote"</span>,</span>
<span id="cb26-4"><a></a><span class="ex">...</span></span>
<span id="cb26-5"><a></a><span class="kw">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-12" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Good to know …</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Docker will not create network names and aliases on the default <code>bridge</code> network.</p></li>
<li><p>Therefore, if you want to use those features, you have to create a custom network first.</p></li>
<li><p>Network aliases are <em>not</em> unique on a given network.</p></li>
<li><p>i.e., multiple containers can have the same alias on the same network.</p></li>
<li><p>In that scenario, the Docker DNS server will return multiple records. <br> (i.e.&nbsp;you will get DNS round robin out of the box.)</p></li>
<li><p>Enabling <em>Swarm Mode</em> gives access to clustering and load balancing with IPVS.</p></li>
<li><p>Creation of networks and network aliases is generally automated with tools like Compose.</p></li>
</ul>
</div>
</div>
</div>
<!--
## Service discovery with containers
:::{.callout-tip icon=false}
## A few words about round robin DNS

Don't rely exclusively on round robin DNS to achieve load balancing.

Many factors can affect DNS resolution, and you might see:

- all traffic going to a single instance;
- traffic being split (unevenly) between some instances;
- different behavior depending on your application language;
- different behavior depending on your base distro;
- different behavior depending on other factors (sic).

It's OK to use DNS to discover available endpoints, but remember that you have to re-resolve every now and then to discover new endpoints.

:::
-->
</section>
<section id="service-discovery-with-containers-13" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Custom networks</strong></p>
</div>
<div class="callout-content">
<p>When creating a network, extra options can be provided.</p>
<ul>
<li><p><code>--internal</code> disables outbound traffic (the network won’t have a default gateway).</p></li>
<li><p><code>--gateway</code> indicates which address to use for the gateway (when outbound traffic is allowed).</p></li>
<li><p><code>--subnet</code> (in CIDR notation) indicates the subnet to use.</p></li>
<li><p><code>--ip-range</code> (in CIDR notation) indicates the subnet to allocate from.</p></li>
<li><p><code>--aux-address</code> allows specifying a list of reserved addresses (which won’t be allocated to containers).</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-14" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Setting containers’ IP address</strong></p>
</div>
<div class="callout-content">
<ul>
<li>It is possible to set a container’s address with <code>--ip</code>.</li>
<li>The IP address has to be within the subnet used for the container.</li>
</ul>
<p>A full example would look like this.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a></a><span class="ex">$</span> docker network create <span class="at">--subnet</span> 10.66.0.0/16 pubnet</span>
<span id="cb27-2"><a></a><span class="ex">42fb16ec412383db6289a3e39c3c0224f395d7f85bcb1859b279e7a564d4e135</span></span>
<span id="cb27-3"><a></a><span class="ex">$</span> docker run <span class="at">--net</span> pubnet <span class="at">--ip</span> 10.66.66.66 <span class="at">-d</span> nginx</span>
<span id="cb27-4"><a></a><span class="ex">b2887adeb5578a01fd9c55c435cad56bbbe802350711d2743691f95743680b09</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>Don’t hard code container IP addresses in your code!</p>
</div>
</div>
</div>
<!--
## Service discovery with containers
:::{.callout-tip icon=false}
## Network drivers

* A network is managed by a *driver*.

* The built-in drivers include:

  * `bridge` (default)
  * `none`
  * `host`
  * `macvlan`
  * `overlay` (for Swarm clusters)

* More drivers can be provided by plugins (OVS, VLAN...)

* A network can have a custom IPAM (IP allocator).

:::

## Service discovery with containers
:::{.callout-tip icon=false}
## Overlay networks

* The features we've seen so far only work when all containers are on a single host.

* If containers span multiple hosts, we need an *overlay* network to connect them together.

* Docker ships with a default network plugin, `overlay`, implementing an overlay network leveraging
  VXLAN, *enabled with Swarm Mode*.

* Other plugins (Weave, Calico...) can provide overlay networks as well.

* Once you have an overlay network, *all the features that we've used in this chapter work identically
  across multiple hosts.*

:::

## Service discovery with containers
:::{.callout-tip icon=false}
## Multi-host networking (overlay)

Out of the scope for this intro-level workshop!

Very short instructions:

- enable Swarm Mode (`docker swarm init` then `docker swarm join` on other nodes)
- `docker network create mynet --driver overlay`
- `docker service create --network mynet myimage`

If you want to learn more about Swarm mode, you can check
[this video](https://www.youtube.com/watch?v=EuzoEaE6Cqs)
or [these slides](https://container.training/swarm-selfpaced.yml.html).

:::

## Service discovery with containers
:::{.callout-tip icon=false}
## Multi-host networking (plugins)

Out of the scope for this intro-level workshop!

General idea:

- install the plugin (they often ship within containers)

- run the plugin (if it's in a container, it will often require extra parameters; don't just `docker run` it blindly!)

- some plugins require configuration or activation (creating a special file that tells Docker "use the plugin whose control socket is at the following location")

- you can then `docker network create --driver pluginname`

:::
-->
</section>
<section id="service-discovery-with-containers-15" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Connecting and disconnecting dynamically</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>So far, we have specified which network to use when starting the container.</p></li>
<li><p>The Docker Engine also allows connecting and disconnecting while the container is running.</p></li>
<li><p>This feature is exposed through the Docker API, and through two Docker CLI commands:</p>
<ul>
<li><p><code>docker network connect &lt;network&gt; &lt;container&gt;</code></p></li>
<li><p><code>docker network disconnect &lt;network&gt; &lt;container&gt;</code></p></li>
</ul></li>
</ul>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-16" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Dynamically connecting to a network</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>We have a container named <code>es</code> connected to a network named <code>dev</code>.</p></li>
<li><p>Let’s start a simple alpine container on the default network:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a></a><span class="ex">$</span> docker run <span class="at">-ti</span> alpine sh</span>
<span id="cb28-2"><a></a><span class="ex">/</span> <span class="co">#</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p>In this container, try to ping the <code>es</code> container:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a></a><span class="ex">/</span> <span class="co"># ping es</span></span>
<span id="cb29-2"><a></a><span class="ex">ping:</span> bad address <span class="st">'es'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This doesn’t work, but we will change that by connecting the container.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-17" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Finding the container ID and connecting it</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Figure out the ID of our alpine container; here are two methods:</p>
<ul>
<li><p>looking at <code>/etc/hostname</code> in the container,</p></li>
<li><p>running <code>docker ps -lq</code> on the host.</p></li>
</ul></li>
<li><p>Run the following command on the host:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a></a><span class="ex">$</span> docker network connect dev <span class="op">&lt;</span>container_id<span class="op">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
</ul>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-18" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Checking what we did</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Try again to <code>ping es</code> from the container.</p></li>
<li><p>It should now work correctly:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a></a><span class="ex">/</span> <span class="co"># ping es</span></span>
<span id="cb31-2"><a></a><span class="ex">PING</span> es <span class="er">(</span><span class="ex">172.20.0.3</span><span class="kw">)</span><span class="bu">:</span> 56 data bytes</span>
<span id="cb31-3"><a></a><span class="ex">64</span> bytes from 172.20.0.3: seq=0 ttl=64 time=0.376 ms</span>
<span id="cb31-4"><a></a><span class="ex">64</span> bytes from 172.20.0.3: seq=1 ttl=64 time=0.130 ms</span>
<span id="cb31-5"><a></a><span class="ex">^C</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p>Interrupt it with Ctrl-C.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-19" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Looking at the network setup in the container</strong></p>
</div>
<div class="callout-content">
<p>We can look at the list of network interfaces with <code>ifconfig</code>, <code>ip a</code>, or <code>ip l</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a></a><span class="ex">/</span> <span class="co"># ip a</span></span>
<span id="cb32-2"><a></a><span class="ex">1:</span> lo: <span class="op">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="op">&gt;</span> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span>
<span id="cb32-3"><a></a>    <span class="ex">link/loopback</span> 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
<span id="cb32-4"><a></a>    <span class="ex">inet</span> 127.0.0.1/8 scope host lo</span>
<span id="cb32-5"><a></a>       <span class="ex">valid_lft</span> forever preferred_lft forever</span>
<span id="cb32-6"><a></a><span class="ex">18:</span> eth0@if19: <span class="op">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN<span class="op">&gt;</span> mtu 1500 qdisc noqueue state UP</span>
<span id="cb32-7"><a></a>    <span class="ex">link/ether</span> 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span>
<span id="cb32-8"><a></a>    <span class="ex">inet</span> 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span>
<span id="cb32-9"><a></a>       <span class="ex">valid_lft</span> forever preferred_lft forever</span>
<span id="cb32-10"><a></a><span class="ex">20:</span> eth1@if21: <span class="op">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN<span class="op">&gt;</span> mtu 1500 qdisc noqueue state UP</span>
<span id="cb32-11"><a></a>    <span class="ex">link/ether</span> 02:42:ac:14:00:04 brd ff:ff:ff:ff:ff:ff</span>
<span id="cb32-12"><a></a>    <span class="ex">inet</span> 172.20.0.4/16 brd 172.20.255.255 scope global eth1</span>
<span id="cb32-13"><a></a>       <span class="ex">valid_lft</span> forever preferred_lft forever</span>
<span id="cb32-14"><a></a><span class="ex">/</span> <span class="co">#</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Each network connection is materialized with a virtual network interface.</p>
<p>As we can see, we can be connected to multiple networks at the same time.</p>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-20" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Disconnecting from a network</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Let’s try the symmetrical command to disconnect the container:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a></a><span class="ex">$</span> docker network disconnect dev <span class="op">&lt;</span>container_id<span class="op">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p>From now on, if we try to ping <code>es</code>, it will not resolve:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a></a><span class="ex">/</span> <span class="co"># ping es</span></span>
<span id="cb34-2"><a></a><span class="ex">ping:</span> bad address <span class="st">'es'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p>Trying to ping the IP address directly won’t work either:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a></a><span class="ex">/</span> <span class="co"># ping 172.20.0.3</span></span>
<span id="cb35-2"><a></a><span class="ex">...</span> <span class="er">(</span><span class="ex">nothing</span> happens until we interrupt it with Ctrl-C<span class="kw">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
</ul>
</div>
</div>
</div>
</section>
<section id="service-discovery-with-containers-21" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Network aliases are scoped per network</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Each network has its own set of network aliases.</p></li>
<li><p>We saw this earlier: <code>es</code> resolves to different addresses in <code>dev</code> and <code>prod</code>.</p></li>
<li><p>If we are connected to multiple networks, the resolver looks up names in each of them (as of Docker Engine 18.03, it is the connection order) and stops as soon as the name is found.</p></li>
<li><p>Therefore, if we are connected to both <code>dev</code> and <code>prod</code>, resolving <code>es</code> will <strong>not</strong> give us the addresses of all the <code>es</code> services; but only the ones in <code>dev</code> or <code>prod</code>.</p></li>
<li><p>However, we can lookup <code>es.dev</code> or <code>es.prod</code> if we need to.</p></li>
</ul>
</div>
</div>
</div>
<!--
## Service discovery with containers
:::{.callout-tip icon=false}
## Finding out about our networks and names

* We can do reverse DNS lookups on containers' IP addresses.

* If the IP address belongs to a network (other than the default bridge), the result will be:

  ```
  name-or-first-alias-or-container-id.network-name
  ```

* Example:

```bash
$ docker run -ti --net prod --net-alias hello alpine
/ # apk add --no-cache drill
...
OK: 5 MiB in 13 packages
/ # ifconfig
eth0      Link encap:Ethernet  HWaddr 02:42:AC:15:00:03
          inet addr:`172.21.0.3`  Bcast:172.21.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
...
/ # drill -t ptr `3.0.21.172`.in-addr.arpa
...
;; ANSWER SECTION:
3.0.21.172.in-addr.arpa.    600 IN  PTR `hello.prod`.
...
```

:::
-->
</section>
<section id="service-discovery-with-containers-22" class="slide level2">
<h2>Service discovery with containers</h2>
<div class="callout callout-tip no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Building with a custom network</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>We can build a Dockerfile with a custom network with <code>docker build --network NAME</code>.</p></li>
<li><p>This can be used to check that a build doesn’t access the network.</p>
<p>(But keep in mind that most Dockerfiles will fail, <br>because they need to install remote packages and dependencies!)</p></li>
<li><p>This may be used to access an internal package repository.</p>
<p>(But try to use a multi-stage build instead, if possible!)</p></li>
</ul>
</div>
</div>
</div>
</section></section>
<section>
<section id="working-with-volumes" class="title-slide slide level1 center">
<h1>Working with volumes</h1>

</section>
<section id="working-with-volumes-1" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Objectives</strong></p>
</div>
<div class="callout-content">
<p>At the end of this section, you will be able to:</p>
<ul>
<li><p>Create containers holding volumes.</p></li>
<li><p>Share volumes across containers.</p></li>
<li><p>Share a host directory with one or many containers.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-2" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Working with volumes</strong></p>
</div>
<div class="callout-content">
<p>Docker volumes can be used to achieve many things, including:</p>
<ul>
<li><p>Bypassing the copy-on-write system to obtain native disk I/O performance.</p></li>
<li><p>Bypassing copy-on-write to leave some files out of <code>docker commit</code>.</p></li>
<li><p>Sharing a directory between multiple containers.</p></li>
<li><p>Sharing a directory between the host and a container.</p></li>
<li><p>Sharing a <em>single file</em> between the host and a container.</p></li>
<li><p>Using remote storage and custom storage with <em>volume drivers</em>.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-4" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Volumes are special directories in a container</strong></p>
</div>
<div class="callout-content">
<p>Volumes can be declared in two different ways:</p>
<ul>
<li>Within a <code>Dockerfile</code>, with a <code>VOLUME</code> instruction.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb36-1"><a></a><span class="kw">VOLUME</span> /uploads</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>On the command-line, with the <code>-v</code> flag for <code>docker run</code>.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">-v</span> /uploads myapp</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>In both cases, <code>/uploads</code> (inside the container) will be a volume.</p>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-5" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Volumes bypass the copy-on-write system</strong></p>
</div>
<div class="callout-content">
<p>Volumes act as passthroughs to the host filesystem.</p>
<ul>
<li><p>The I/O performance on a volume is exactly the same as I/O performance on the Docker host.</p></li>
<li><p>When you <code>docker commit</code>, the content of volumes is not brought into the resulting image.</p></li>
<li><p>If a <code>RUN</code> instruction in a <code>Dockerfile</code> changes the content of a volume, those changes are not recorded neither.</p></li>
<li><p>If a container is started with the <code>--read-only</code> flag, the volume will still be writable (unless the volume is a read-only volume).</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-6" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Volumes can be shared across containers</strong></p>
</div>
<div class="callout-content">
<ul>
<li>You can start a container with <em>exactly the same volumes</em> as another one.</li>
<li>The new container will have the same volumes, in the same directories.</li>
<li>They will contain exactly the same thing, and remain in sync.</li>
<li>Under the hood, they are actually the same directories on the host anyway.</li>
<li>This is done using the <code>--volumes-from</code> flag for <code>docker run</code>.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-7" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Sharing app server logs with another container</strong></p>
</div>
<div class="callout-content">
<p>Let’s start a Tomcat container:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a></a><span class="ex">$</span> docker run <span class="at">--name</span> webapp <span class="at">-d</span> <span class="at">-p</span> 8080:8080 <span class="at">-v</span> /usr/local/tomcat/logs tomcat</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now, start an <code>alpine</code> container accessing the same volume:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a></a><span class="ex">$</span> docker run <span class="at">--volumes-from</span> webapp alpine sh <span class="at">-c</span> <span class="st">"tail -f /usr/local/tomcat/logs/*"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then, from another window, send requests to our Tomcat container:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a></a><span class="ex">$</span> curl localhost:8080</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-8" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Volumes exist independently of containers</strong></p>
</div>
<div class="callout-content">
<p>If a container is stopped or removed, its volumes still exist and are available.</p>
<p>Volumes can be listed and manipulated with <code>docker volume</code> subcommands:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a></a><span class="ex">$</span> docker volume ls</span>
<span id="cb41-2"><a></a><span class="ex">DRIVER</span>              VOLUME NAME</span>
<span id="cb41-3"><a></a><span class="bu">local</span>               5b0b65e4316da67c2d471086640e6005ca2264f3...</span>
<span id="cb41-4"><a></a><span class="bu">local</span>               <span class="va">pgdata</span>-prod</span>
<span id="cb41-5"><a></a><span class="bu">local</span>               <span class="va">pgdata</span>-dev</span>
<span id="cb41-6"><a></a><span class="bu">local</span>               13b59c9936d78d109d094693446e174e5480d973...</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Some of those volume names were explicit (pgdata-prod, pgdata-dev).</p>
<p>The others (the hex IDs) were generated automatically by Docker.</p>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-9" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Naming volumes</strong></p>
</div>
<div class="callout-content">
<ul>
<li>Volumes can be created without a container, then used in multiple containers.</li>
</ul>
<p>Let’s create a couple of volumes directly.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a></a><span class="ex">$</span> docker volume create webapps</span>
<span id="cb42-2"><a></a><span class="ex">webapps</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a></a><span class="ex">$</span> docker volume create logs</span>
<span id="cb43-2"><a></a><span class="ex">logs</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Volumes are not anchored to a specific path.</p>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-10" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Populating volumes</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>When an empty volume is mounted on a non-empty directory, the directory is copied to the volume.</p></li>
<li><p>This makes it easy to “promote” a normal directory to a volume.</p></li>
<li><p>Non-empty volumes are always mounted as-is.</p></li>
</ul>
<p>Let’s populate the webapps volume with the webapps.dist directory from the Tomcat image.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb44-1"><a></a><span class="ex">$</span> docker run <span class="at">-v</span> webapps:/usr/local/tomcat/webapps.dist tomcat true</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>Running <code>true</code> will cause the container to exit successfully once the <code>webapps.dist</code> directory has been copied to the <code>webapps</code> volume, instead of starting tomcat.</p>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-11" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Using our named volumes</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Volumes are used with the <code>-v</code> option.</p></li>
<li><p>When a host path does not contain a <code>/</code>, it is considered a volume name.</p></li>
</ul>
<p>Let’s start a web server using the two previous volumes.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb45-1"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">-p</span> 1234:8080 <span class="dt">\</span></span>
<span id="cb45-2"><a></a>         <span class="at">-v</span> logs:/usr/local/tomcat/logs <span class="dt">\</span></span>
<span id="cb45-3"><a></a>         <span class="at">-v</span> webapps:/usr/local/tomcat/webapps <span class="dt">\</span></span>
<span id="cb45-4"><a></a>         tomcat</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Check that it’s running correctly:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a></a><span class="ex">$</span> curl localhost:1234</span>
<span id="cb46-2"><a></a><span class="ex">...</span> <span class="er">(</span><span class="ex">Tomcat</span> tells us how happy it is to be up and running<span class="kw">)</span> <span class="ex">...</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-12" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Using a volume in another container</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>We will make changes to the volume from another container.</p></li>
<li><p>In this example, we will run a text editor in the other container.</p>
<p>(But this could be an FTP server, a WebDAV server, a Git receiver…)</p></li>
</ul>
<p>Let’s start another container using the <code>webapps</code> volume.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb47-1"><a></a><span class="ex">$</span> docker run <span class="at">-v</span> webapps:/webapps <span class="at">-w</span> /webapps <span class="at">-ti</span> alpine vi ROOT/index.jsp</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Vandalize the page, save, exit.</p>
<p>Then run <code>curl localhost:1234</code> again to see your changes.</p>
</div>
</div>
</div>
<!--
## Working with volumes
:::{.callout-note icon=false}
## Using custom "bind-mounts"

In some cases, you want a specific directory on the host to be mapped
inside the container:

* You want to manage storage and snapshots yourself.

    (With LVM, or a SAN, or ZFS, or anything else!)

* You have a separate disk with better performance (SSD) or resiliency (EBS)
  than the system disk, and you want to put important data on that disk.

* You want to share your source directory between your host (where the
  source gets edited) and the container (where it is compiled or executed).

Wait, we already met the last use-case in our example development workflow!
Nice.

```bash
$ docker run -d -v /path/on/the/host:/path/in/container image ...
```

:::
-->
</section>
<section id="working-with-volumes-13" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Migrating data with <code>--volumes-from</code></strong></p>
</div>
<div class="callout-content">
<p>The <code>--volumes-from</code> option tells Docker to re-use all the volumes of an existing container.</p>
<ul>
<li><p>Scenario: migrating from Redis 2.8 to Redis 3.0.</p></li>
<li><p>We have a container (<code>myredis</code>) running Redis 2.8.</p></li>
<li><p>Stop the <code>myredis</code> container.</p></li>
<li><p>Start a new container, using the Redis 3.0 image, and the <code>--volumes-from</code> option.</p></li>
<li><p>The new container will inherit the data of the old one.</p></li>
<li><p>Newer containers can use <code>--volumes-from</code> too.</p></li>
<li><p>Doesn’t work across servers, so not usable in clusters (Swarm, Kubernetes).</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-14" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Data migration in practice</strong></p>
</div>
<div class="callout-content">
<p>Let’s create a Redis container.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb48-1"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">--name</span> redis28 redis:2.8</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Connect to the Redis container and set some data.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb49-1"><a></a><span class="ex">$</span> docker run <span class="at">-ti</span> <span class="at">--link</span> redis28:redis busybox telnet redis 6379</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Issue the following commands:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb50-1"><a></a><span class="ex">SET</span> counter 42</span>
<span id="cb50-2"><a></a><span class="ex">INFO</span> server</span>
<span id="cb50-3"><a></a><span class="ex">SAVE</span></span>
<span id="cb50-4"><a></a><span class="ex">QUIT</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-15" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Upgrading Redis</strong></p>
</div>
<div class="callout-content">
<p>Stop the Redis container.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb51-1"><a></a><span class="ex">$</span> docker stop redis28</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Start the new Redis container.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb52-1"><a></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">--name</span> redis30 <span class="at">--volumes-from</span> redis28 redis:3.0</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-16" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Testing the new Redis</strong></p>
</div>
<div class="callout-content">
<p>Connect to the Redis container and see our data.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb53-1"><a></a><span class="ex">docker</span> run <span class="at">-ti</span> <span class="at">--link</span> redis30:redis busybox telnet redis 6379</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Issue a few commands.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb54-1"><a></a><span class="ex">GET</span> counter</span>
<span id="cb54-2"><a></a><span class="ex">INFO</span> server</span>
<span id="cb54-3"><a></a><span class="ex">QUIT</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-17" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Volumes lifecycle</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>When you remove a container, its volumes are kept around.</p></li>
<li><p>You can list them with <code>docker volume ls</code>.</p></li>
<li><p>You can access them by creating a container with <code>docker run -v</code>.</p></li>
<li><p>You can remove them with <code>docker volume rm</code> or <code>docker system prune</code>.</p></li>
</ul>
<p>Ultimately, <em>you</em> are the one responsible for logging, monitoring, and backup of your volumes.</p>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-18" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Checking volumes defined by an image</strong></p>
</div>
<div class="callout-content">
<p>Wondering if an image has volumes? Just use <code>docker inspect</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb55-1"><a></a><span class="ex">$</span> <span class="co"># docker inspect training/datavol</span></span>
<span id="cb55-2"><a></a><span class="ex">[{</span></span>
<span id="cb55-3"><a></a>  <span class="st">"config"</span><span class="ex">:</span> {</span>
<span id="cb55-4"><a></a>    <span class="bu">.</span> . .</span>
<span id="cb55-5"><a></a>    <span class="st">"Volumes"</span><span class="ex">:</span> {</span>
<span id="cb55-6"><a></a>        <span class="st">"/var/webapp"</span><span class="ex">:</span> {}</span>
<span id="cb55-7"><a></a>    <span class="er">}</span><span class="ex">,</span></span>
<span id="cb55-8"><a></a>    <span class="bu">.</span> . .</span>
<span id="cb55-9"><a></a><span class="er">}</span><span class="ex">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-19" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Checking volumes used by a container</strong></p>
</div>
<div class="callout-content">
<p>To look which paths are actually volumes, and to what they are bound, use <code>docker inspect</code> (again):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb56-1"><a></a><span class="ex">$</span> docker inspect <span class="op">&lt;</span>yourContainerID<span class="op">&gt;</span></span>
<span id="cb56-2"><a></a><span class="ex">[{</span></span>
<span id="cb56-3"><a></a>  <span class="st">"ID"</span><span class="ex">:</span> <span class="st">"&lt;yourContainerID&gt;"</span>,</span>
<span id="cb56-4"><a></a><span class="bu">.</span> . .</span>
<span id="cb56-5"><a></a>  <span class="st">"Volumes"</span><span class="ex">:</span> {</span>
<span id="cb56-6"><a></a>     <span class="st">"/var/webapp"</span><span class="ex">:</span> <span class="st">"/var/lib/docker/vfs/dir/f4280c5b6207ed531efd4cc673ff620cef2a7980f747dbbcca001db61de04468"</span></span>
<span id="cb56-7"><a></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb56-8"><a></a>  <span class="st">"VolumesRW"</span><span class="ex">:</span> {</span>
<span id="cb56-9"><a></a>     <span class="st">"/var/webapp"</span><span class="ex">:</span> true</span>
<span id="cb56-10"><a></a>  <span class="er">}</span><span class="ex">,</span></span>
<span id="cb56-11"><a></a><span class="er">}</span><span class="ex">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>We can see that our volume is present on the file system of the Docker host.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-20" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Sharing a single file</strong></p>
</div>
<div class="callout-content">
<p>The same <code>-v</code> flag can be used to share a single file (instead of a directory).</p>
<p>One of the most interesting examples is to share the Docker control socket.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb57-1"><a></a><span class="ex">$</span> docker run <span class="at">-it</span> <span class="at">-v</span> /var/run/docker.sock:/var/run/docker.sock docker sh</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>From that container, you can now run <code>docker</code> commands communicating with the Docker Engine running on the host. Try <code>docker ps</code>!</p>
</div>
</div>
</div>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Warning</strong></p>
</div>
<div class="callout-content">
<p>Since that container has access to the Docker socket, it has root-like access to the host.</p>
</div>
</div>
</div>
<!--
## Working with volumes
:::{.callout-note icon=false}
## Volume plugins

You can install plugins to manage volumes backed by particular storage systems,
or providing extra features. For instance:

* [REX-Ray](https://rexray.io/) - create and manage volumes backed by an enterprise storage system (e.g.
  SAN or NAS), or by cloud block stores (e.g. EBS, EFS).

* [Portworx](https://portworx.com/) - provides distributed block store for containers.

* [Gluster](https://www.gluster.org/) - open source software-defined distributed storage that can scale
  to several petabytes. It provides interfaces for object, block and file storage.

* and much more at the [Docker Store](https://store.docker.com/search?category=volume&q=&type=plugin)!

:::
-->
</section>
<section id="working-with-volumes-21" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Volumes vs.&nbsp;Mounts</strong></p>
</div>
<div class="callout-content">
<ul>
<li><p>Since Docker 17.06, a new options is available: <code>--mount</code>.</p></li>
<li><p>It offers a new, richer syntax to manipulate data in containers.</p></li>
<li><p>It makes an explicit difference between:</p>
<ul>
<li><p>volumes (identified with a unique name, managed by a storage plugin),</p></li>
<li><p>bind mounts (identified with a host path, not managed).</p></li>
</ul></li>
<li><p>The former <code>-v</code> / <code>--volume</code> option is still usable.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-22" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong><code>--mount</code> syntax</strong></p>
</div>
<div class="callout-content">
<p>Binding a host path to a container path:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb58-1"><a></a><span class="ex">$</span> docker run <span class="dt">\</span></span>
<span id="cb58-2"><a></a>  <span class="at">--mount</span> type=bind,source=/path/on/host,target=/path/in/container alpine</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Mounting a volume to a container path:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb59"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb59-1"><a></a><span class="ex">$</span> docker run <span class="dt">\</span></span>
<span id="cb59-2"><a></a>  <span class="at">--mount</span> source=myvolume,target=/path/in/container alpine</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Mounting a tmpfs (in-memory, for temporary files):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb60"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb60-1"><a></a><span class="ex">$</span> docker run <span class="dt">\</span></span>
<span id="cb60-2"><a></a>  <span class="at">--mount</span> type=tmpfs,destination=/path/in/container,tmpfs-size=1000000 alpine</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</section>
<section id="working-with-volumes-23" class="slide level2">
<h2>Working with volumes</h2>
<div class="callout callout-note no-icon callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<p><strong>Section summary</strong></p>
</div>
<div class="callout-content">
<p>We’ve learned how to:</p>
<ul>
<li><p>Create and manage volumes.</p></li>
<li><p>Share volumes across containers.</p></li>
<li><p>Share a host directory with one or many containers.</p></li>
</ul>
</div>
</div>
</div>


</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="site_libs/revealjs/plugin/multiplex/socket.io.js"></script>
  <script src="site_libs/revealjs/plugin/multiplex/multiplex.js"></script>
  <script src="site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="site_libs/revealjs/plugin/search/search.js"></script>
  <script src="site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': true,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'multiplex': {"url":"https://mplex.vitv.ly","secret":"2a01204f753aed73e42e2d0506747066","id":"e90053bf8fd1cc7a37d55d1d3b5223f5273b8e1c78f5d7d300b6c5c4d4f86033"},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
          const outerScaffold = trigger.parentElement.cloneNode(true);
          const codeEl = outerScaffold.querySelector('code');
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>